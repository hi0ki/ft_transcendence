generator client {
	provider = "prisma-client-js"
}

datasource db {
	provider = "postgresql"
	url      = env("DATABASE_URL")
}

// enums
enum PostType {
	HELP
	RESOURCE
	MEME
}

enum NotificationType {
	COMMENT
	LIKE
	MESSAGE
	FRIEND_REQUEST
	OTHER
}

enum MessageType {
	TEXT
	IMAGE
	FILE
	VOICE
	OTHER
}

enum FriendshipStatus {
	PENDING
	ACCEPTED
	BLOCKED
}

// models
model User {
	id            BigInt          @id @default(autoincrement()) @db.BigInt
	email         String          @unique
	passwordHash  String?
	oauthProvider String?
	oauthId       String?
	createdAt     DateTime        @default(now()) @db.Timestamptz(6)

	profile               Profile?
	posts                 Post[]
	comments              Comment[]
	likes                 Like[]
	notifications         Notification[]
	conversationsAsUser1  Conversation[] @relation("ConversationUser1")
	conversationsAsUser2  Conversation[] @relation("ConversationUser2")
	messages              Message[]
	friendships           Friendship[]   @relation("UserFriendships", fields: [], references: [])
	
	@@map("users")
}

model Profile {
	userId    BigInt  @id @db.BigInt
	user      User    @relation(fields: [userId], references: [id])
	username  String  @unique
	fullName  String?
	avatarUrl String?
	bio       String?

	@@map("profiles")
}

model Post {
	id        BigInt     @id @default(autoincrement()) @db.BigInt
	userId    BigInt     @db.BigInt
	user      User       @relation(fields: [userId], references: [id])
	type      PostType
	title     String?
	content   String
	createdAt DateTime   @default(now()) @db.Timestamptz(6)

	comments  Comment[]
	likes     Like[]
	notifications Notification[]

	@@index([userId])
	@@map("posts")
}

model Comment {
	id        BigInt   @id @default(autoincrement()) @db.BigInt
	postId    BigInt   @db.BigInt
	post      Post     @relation(fields: [postId], references: [id])
	userId    BigInt   @db.BigInt
	author    User     @relation(fields: [userId], references: [id])
	content   String
	createdAt DateTime @default(now()) @db.Timestamptz(6)

	@@index([postId])
	@@index([userId])
	@@map("comments")
}

model Like {
	userId    BigInt   @db.BigInt
	postId    BigInt   @db.BigInt
	user      User     @relation(fields: [userId], references: [id])
	post      Post     @relation(fields: [postId], references: [id])
	createdAt DateTime @default(now()) @db.Timestamptz(6)

	@@id([userId, postId])
	@@index([postId])
	@@map("likes")
}

model Notification {
	id         BigInt           @id @default(autoincrement()) @db.BigInt
	userId     BigInt           @db.BigInt        // who receives
	user       User             @relation(fields: [userId], references: [id])
	senderId   BigInt?          @db.BigInt        // who triggered (nullable)
	sender     User?            @relation("NotificationSender", fields: [senderId], references: [id])
	postId     BigInt?          @db.BigInt
	post       Post?            @relation(fields: [postId], references: [id])
	type       NotificationType
	isRead     Boolean          @default(false)
	createdAt  DateTime         @default(now()) @db.Timestamptz(6)

	@@index([userId])
	@@map("notifications")
}

model Conversation {
	id        BigInt    @id @default(autoincrement()) @db.BigInt
	user1Id   BigInt    @db.BigInt
	user1     User      @relation("ConversationUser1", fields: [user1Id], references: [id])
	user2Id   BigInt    @db.BigInt
	user2     User      @relation("ConversationUser2", fields: [user2Id], references: [id])
	createdAt DateTime  @default(now()) @db.Timestamptz(6)

	messages  Message[]

	@@unique([user1Id, user2Id])
	@@index([user1Id])
	@@index([user2Id])
	@@map("conversations")
}

model Message {
	id             BigInt      @id @default(autoincrement()) @db.BigInt
	conversationId BigInt      @db.BigInt
	conversation   Conversation @relation(fields: [conversationId], references: [id])
	senderId       BigInt      @db.BigInt
	sender         User        @relation(fields: [senderId], references: [id])
	type           MessageType
	content        String?
	fileUrl        String?
	isRead         Boolean     @default(false)
	createdAt      DateTime    @default(now()) @db.Timestamptz(6)

	@@index([conversationId])
	@@index([senderId])
	@@map("messages")
}

model Friendship {
	userId    BigInt           @db.BigInt
	friendId  BigInt           @db.BigInt
	user      User             @relation("UserFriendships", fields: [userId], references: [id])
	friend    User             @relation("FriendOf", fields: [friendId], references: [id])
	status    FriendshipStatus
	createdAt DateTime         @default(now()) @db.Timestamptz(6)

	@@id([userId, friendId])
	@@index([friendId])
	@@map("friendships")
}